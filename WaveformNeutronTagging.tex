\documentclass[main.tex]{subfiles}
\begin{document}

\section{Waveform Neutron Tagging}
-technology has improved and prizes lowered. ToF with digitized signals opens new possibilities. Advantage is we have more information to work with (expand). disadvantage takes up storage space, but bulk of data can be discarded when desired features are extracted.
\subsection{Digitizer specifications and configuration}
model, sampling rate, channels, thresholds, windowlength, polarity, baseline
\subsection{Data collection and processing}
caenlib, wavedump, txtfile to dataframe. thresholds, throwing away junk.
Show examples of pulses that get thrown away! Threshold min (and max overflow). early/late cfdtriggers.
Show example of datastructure.

\begin{figure}[ht!]
    \centering
        \includegraphics[width=1\textwidth]{DigitalSetup/badevents.pdf}
        \caption{Since The NE213 detector is used for pulseshape discrimination it is important that (A) the the baseline is stable, (B) that the pulse rise does not land in the baseline determination window (a subset of (A)), (C) the tail of the pulse is contained. (D) Moreover Closely adjacent pulses may on rare occasions cause the cfd algorithm to find a slope of the wrong sign.}
    \label{fig:badevents} 
\end{figure}

\subsubsection{Timestamping}
The detector signals are led through a patch panel and into an attenuator in order to lower the signal amplitudes. From there they are fed directly into the digitizer. The digitizer will trigger on all enabled channel when the threshold on one channel is surpassed, so a lot of the events will be empty and some will consists of partially contained events. The digitizer used for this project was a a model vx1751 from CAEN, and controlled through the software WaveDumpis. The format of the data is:
\begin{figure}[ht!]
    \centering
        \includegraphics[width=\textwidth]{DigitalSetup/goodevents.pdf}
        \caption{A cfd algorithm is used to generate precise timestamp. Here a cfd trigger of 30\% is used.}
    \label{fig:badevents} 
\end{figure}
\{number of samples per window, digitizer model id, Channel number, Event Number, mask, trigger timestamp, DC offset (DAC), samples\}


%channel mask: decimal representation of the channelmask sent to the digitizer. For an eigth channel digitizer an eigth bit array is sent, with each index setting a channel on or off. $5\rightarrow 00000101\rightarrow$ channel 0 and 1 enabled.

The digitizer triggers on all enabled channels at the same time, so often when a pulse is recorded in one channel nothing an empty sampling window is recorded in the other channels. The data received from the digitizer is processed in order to throw away these empty events, as well as to extract additional features such integrated charge, height, width and a corrected timestamp.

In order to get a good time of flight spectrum we need to have a precise timestamp for each pulse from the detectors. A general timestamp is provided by the digitizer for each event, but a single event may be hundreds or thousands of samples long. For the vc1751 digitizer each sample corresponds to 1 ns, and with detector signals from the NE213 detector and the YAPs ranging from 10-100 ns, then the timestamp needs to be refined.

Fig \ref{fig:not-aligned} shows five pulses from the NE213 detector. The approximate location of the pulses in the sampling window can be specified when the digitizer is configured, through the posttrigger parameter. However, this is not very precise, and the pulses may be located several tens of nanoseconds apart. 

Aligning pulses by peak height location \ref{fig:peak-aligned} results in some improvement but also leads to timewalk.

The leading edge method employed to get \ref{fig:leading_edge-aligned} aligns all pulses around the points where they first surpass a fixed threshold. This method can provide good results provided that the threshold is small compared to the lowest pulseheights. 

By using a constant fraction discrimination (cfd) algorithm the five pulses have been aligned in Fig \ref{fig:cfd-aligned}. The cfd algorithm simply scans through an event and locates the first bin to reach a chosen fraction of the pulse's peak value. In Fig \ref{fig:alignment} 50\% of the peak height was used as the constant fraction. 

Both the leading edge and the cfd algorithm align all the pulses within one nanosecond of each other. Thus by adding the time value acquired by either of these algorithms we get the precision we need in order to perform time of flight measurements.
%INSERT PLOTS

\end{document}